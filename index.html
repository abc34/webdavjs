<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script type="text/javascript" src="src/webdav.js"></script>
    <!--
    <script type="text/javascript" src="src/jquery-3.1.1.slim.min.js"></script>
    -->
    <script type="text/javascript">
      
      var Q = (function()
      {
        debugger;

        var Qevents=function(){};
        Qevents.prototype =
        {
          map: new WeakMap(),
          set: function(el,event,handler,data)
          {
            this.has(el,event,handler,data) &&  this.delete(el,event,handler,data);
            var map_ev = this.map.has(el)?this.map.get(el):new Map();
            var map_ha = map_ev.has(event)?map_ev.get(event):new Map();
            var map_da = map_ha.has(handler)?map_ha.get(handler):new Map();
            map_da.set(data,true);
            map_ha.set(handler,map_da);
            map_ev.set(event,map_ha);
            this.map.set(el,map_ev);
            el.addEventListener(event,handler,data.options);
          },
          has: function(el,event,handler,data)
          {
            debugger;
            var map_ev = this.map.get(el); if(!map_ev) return false;
            var map_ha = map_ev.get(event); if(!map_ha) return false;
            var map_da = map_ha.get(handler); if(!map_da) return false;
            return map_da.has(data);
          },
          delete: function(el,event,handler,data)
          {
            var map_ev = this.map.get(el); if(!map_ev) return false;
            var map_ha = map_ev.get(event); if(!map_ha) return false;
            var map_da = map_ha.get(handler); if(!map_da) return false;
            map_da.delete(data);
            map_da.size===0 && map_ha.delete(handler);
            map_ha.size===0 && map_ev.delete(event);
            map_ev.size===0 && this.map.delete(el);
            el.removeEventListener(event,handler,data.options);
          }
        };
        Qevents=new Qevents();


        var q=function(v)
        {
          if(!(this instanceof q))return new q(v);
          this.el=v;
          if(typeof v === 'string')
            this.el=document.querySelector(v);
        };
        q.prototype = 
        {
          on: function(event, handler, data){
            var opt = {type: event, handler: handler, options: {capture:false, once:false}, data:data};
            Qevents.set(this.el,event,handler,opt);
          },
          once: function(event, handler, data){
            var opt = {type: event, handler: handler, options: {capture:false, once:true}, data:data};
            Qevents.set(this.el,event,handler,opt);
          },
          off: function(event, handler, data){
            var opt = {type: event, handler: handler, options: {capture:false, once:false},data:data};
            Qevents.delete(this.el,event,handler,opt);
          },

          ready: function(handler){
            this.on('DOMContentLoaded',handler,null);
          },

          find: function(sel){
            return new q(this.el.querySelector(sel));
          }
        };

        return q;

      })();





      var fs = new WebDAV.Fs('https://rockstor.lan:7500','admin','open');
      var handler = function(e)
      {
        var li = e.target.parentElement;
        if(li.classList.contains('active'))
          li.querySelector('ul').remove();
        else
          loadDir(new fs.dir(e.target.href), li);
        li.classList.toggle('active');
        return false;
      }
      //template string
      function Format(s,data)
      {
        if(Array.isArray(data) || data.hasOwnProperty('length') && data.hasOwnProperty('0'))
        {
          for(var r=[],i=0;i<data.length;i++)
            r.push(s.replace(/\$\{(\w*)\}/g, function(v,key){return data[i].hasOwnProperty(key)?data[i][key]:"";}));
          return r;
        }
        else
          return s.replace(/\$\{(\w*)\}/g, function(v,key){return data.hasOwnProperty(key)?data[key]:"";});
        //var r, keys=[];
        //s = s.replace("'","\'");
        //s = '\''+s.replace(/\$\{(\w*)\}/g, function(m,key) { return '\'+____data[\0][\''+key+'\']+\''; })+'\'';
        //s = s.split('\0');
        //r = new Array(data.length).fill(0);
        //s = r.map(function(a,i){return s.join(i);});
        //s = s.join('+');
        //s = (new Function('____data','return '+s+';'))(data);
      }

      var loadDir = function(dir, parentNode)
      {
        if(typeof parentNode === 'string') parentNode = document.querySelector(parentNode);
        dir.children().then(function(children)
        {
          var ul = '<ul>'+Format('<li class=${type}><a href=${url}>${name}</a></li>',children).join('')+'</ul>';
          parentNode.innerHTML=ul;
          Q(parentNode).find('ul>li.dir a').on('click', handler);//!!! only for one <a>
        });
      };

      Q(document).ready(function()
      {
        (new fs.dir('/')).mkdir('Folder/');

        loadDir(new fs.dir('/'), '#root');
      });
    </script>
  </head>
  <body>
    <h1>WebDAV.js example</h1>
    
    <div id="root"></div>
  </body>
</html>
