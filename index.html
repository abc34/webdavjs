<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script type="text/javascript" src="src/webdav.js"></script>
    <!--
    <script type="text/javascript" src="src/jquery-3.1.1.slim.min.js"></script>
    -->
    <script type="text/javascript" src="src/qlib.js"></script>
    <script type="text/javascript">      
      var fs = new WebDAV.Fs('https://rockstor.lan:7500','admin','open');
      var handler = function(e)
      {
        e.preventDefault();
        var li = e.target.parentElement;
        if(li.classList.contains('active'))
          li.querySelector('ul').remove();
        else
          loadDir(new fs.dir(e.target.href), li);
        li.classList.toggle('active');
        return false;
      }
      //template string
      function Format(s,data)
      {
        if(Array.isArray(data) || data.hasOwnProperty('length') && data.hasOwnProperty('0'))
        {
          for(var r=[],i=0;i<data.length;i++)
            r.push(s.replace(/\$\{(\w*)\}/g, function(v,key){return data[i].hasOwnProperty(key)?data[i][key]:"";}));
          return r;
        }
        else
          return s.replace(/\$\{(\w*)\}/g, function(v,key){return data.hasOwnProperty(key)?data[key]:"";});
        //var r, keys=[];
        //s = s.replace("'","\'");
        //s = '\''+s.replace(/\$\{(\w*)\}/g, function(m,key) { return '\'+____data[\0][\''+key+'\']+\''; })+'\'';
        //s = s.split('\0');
        //r = new Array(data.length).fill(0);
        //s = r.map(function(a,i){return s.join(i);});
        //s = s.join('+');
        //s = (new Function('____data','return '+s+';'))(data);
      }

      var loadDir = function(dir, parentNode)
      {
        if(typeof parentNode === 'string') parentNode = document.querySelector(parentNode);
        dir.children().then(function(children)
        {
          var ul = '<ul>'+Format('<li class=${type}><a href=${url}>${name}</a></li>',children).join('')+'</ul>';
          Q(parentNode).append(ul);
          Q(parentNode).find('ul>li.dir a').on('click', handler);
        });
      };

      Q(document).ready(function()
      {
        (new fs.dir('/')).mkdir('Folder/');

        loadDir(new fs.dir('/'), '#root');
      });
    </script>
  </head>
  <body>
    <h1>WebDAV.js example</h1>
    
    <div id="root"></div>
  </body>
</html>
